<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surf Map Marker Duplication Fix Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-instructions {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .test-steps {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        
        .test-results {
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
            display: none;
        }
        
        .error-results {
            background: #f8d7da;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
            display: none;
        }
        
        .surf-map-container {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .marker-counter {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Surf Map Marker Duplication Fix Test</h1>
            <p>Test to verify that surf spot markers no longer duplicate when zooming out</p>
        </div>
        
        <div class="test-instructions">
            <h3>üìã Test Instructions</h3>
            <p>This test verifies that the marker duplication issue has been fixed. The issue occurred when zooming out, where multiple copies of surf spot markers would appear and remain on the map.</p>
        </div>
        
        <div class="test-steps">
            <h3>üîç Test Steps</h3>
            <ol>
                <li>Wait for the surf map to load completely</li>
                <li>Notice the initial number of visible markers</li>
                <li>Zoom out using the mouse wheel or zoom controls</li>
                <li>Zoom back in to the original level</li>
                <li>Repeat the zoom in/out cycle several times rapidly</li>
                <li>Observe whether markers duplicate or accumulate</li>
                <li>Check the marker counter to ensure it remains consistent</li>
            </ol>
        </div>
        
        <div class="test-results" id="testResults">
            <h3>‚úÖ Test Results</h3>
            <p id="testResultText"></p>
        </div>
        
        <div class="error-results" id="errorResults">
            <h3>‚ùå Test Error</h3>
            <p id="errorText"></p>
        </div>
        
        <div class="marker-counter" id="markerCounter">
            Visible Markers: <span id="markerCount">0</span>
        </div>
        
        <button class="test-button" onclick="startTest()">Start Test</button>
        <button class="test-button" onclick="resetTest()">Reset Test</button>
        <button class="test-button" onclick="runAutomatedTest()">Run Automated Test</button>
        
        <div class="surf-map-container" id="surfMapContainer">
            <div class="loading">Loading surf map...</div>
        </div>
    </div>

    <!-- Include the surf map styles -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style/surf-spot-panel-optimized.css">

    <script type="module">
        let surfMap = null;
        let testRunning = false;
        let initialMarkerCount = 0;
        let markerCounts = [];
        
        // Import the surf map modules
        import { SurfMap } from './scripts/surf-map/surf-map-core.js';
        
        async function initializeMap() {
            try {
                const container = document.getElementById('surfMapContainer');
                
                // Create surf map instance
                surfMap = new SurfMap(container, {
                    imagePath: 'images/surf-map.webp',
                    minZoom: 0.2,
                    maxZoom: 3.0,
                    initialZoom: 0.8
                });
                
                // Wait for map to be ready
                surfMap.on('ready', () => {
                    console.log('Surf map is ready for testing');
                    updateMarkerCount();
                    document.querySelector('.loading').style.display = 'none';
                });
                
                // Track marker count changes
                surfMap.on('viewChange', () => {
                    if (testRunning) {
                        updateMarkerCount();
                    }
                });
                
                surfMap.on('error', (error) => {
                    console.error('Surf map error:', error);
                    showError('Map initialization failed: ' + error.message);
                });
                
            } catch (error) {
                console.error('Failed to initialize surf map:', error);
                showError('Failed to initialize surf map: ' + error.message);
            }
        }
        
        function updateMarkerCount() {
            if (surfMap) {
                const visibleSpots = surfMap.getVisibleSpots();
                const count = visibleSpots.length;
                document.getElementById('markerCount').textContent = count;
                
                if (testRunning) {
                    markerCounts.push({
                        timestamp: Date.now(),
                        count: count,
                        zoom: surfMap.state.zoom
                    });
                }
            }
        }
        
        window.startTest = function() {
            if (!surfMap) {
                showError('Surf map is not initialized yet');
                return;
            }
            
            testRunning = true;
            markerCounts = [];
            initialMarkerCount = parseInt(document.getElementById('markerCount').textContent);
            
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('errorResults').style.display = 'none';
            
            console.log('Test started. Initial marker count:', initialMarkerCount);
            
            // Show test instructions
            showResult('Test started. Perform zoom in/out operations and observe marker behavior.');
        };
        
        window.resetTest = function() {
            testRunning = false;
            markerCounts = [];
            initialMarkerCount = 0;
            
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('errorResults').style.display = 'none';
            
            if (surfMap) {
                surfMap.resetView();
                updateMarkerCount();
            }
            
            console.log('Test reset');
        };
        
        window.runAutomatedTest = async function() {
            if (!surfMap) {
                showError('Surf map is not initialized yet');
                return;
            }
            
            testRunning = true;
            markerCounts = [];
            initialMarkerCount = parseInt(document.getElementById('markerCount').textContent);
            
            console.log('Running automated test...');
            showResult('Running automated test...');
            
            try {
                // Test 1: Zoom out and in multiple times
                for (let i = 0; i < 5; i++) {
                    console.log(`Test iteration ${i + 1}`);
                    
                    // Zoom out
                    surfMap.zoomOut(0.2);
                    await sleep(500);
                    
                    // Zoom in
                    surfMap.zoomIn(0.2);
                    await sleep(500);
                }
                
                // Analyze results
                analyzeTestResults();
                
            } catch (error) {
                console.error('Automated test failed:', error);
                showError('Automated test failed: ' + error.message);
            }
        };
        
        function analyzeTestResults() {
            if (markerCounts.length === 0) {
                showError('No test data collected');
                return;
            }
            
            const finalMarkerCount = markerCounts[markerCounts.length - 1].count;
            const maxMarkerCount = Math.max(...markerCounts.map(m => m.count));
            const minMarkerCount = Math.min(...markerCounts.map(m => m.count));
            
            console.log('Test Results:');
            console.log('Initial marker count:', initialMarkerCount);
            console.log('Final marker count:', finalMarkerCount);
            console.log('Max marker count:', maxMarkerCount);
            console.log('Min marker count:', minMarkerCount);
            
            // Check for marker duplication (final count should be close to initial)
            const countDifference = Math.abs(finalMarkerCount - initialMarkerCount);
            const duplicateThreshold = Math.max(5, initialMarkerCount * 0.1); // 10% or 5 markers
            
            if (countDifference <= duplicateThreshold) {
                showResult(`‚úÖ Test PASSED: No significant marker duplication detected.\n\n` +
                          `Initial markers: ${initialMarkerCount}\n` +
                          `Final markers: ${finalMarkerCount}\n` +
                          `Max markers: ${maxMarkerCount}\n` +
                          `Min markers: ${minMarkerCount}\n` +
                          `Difference: ${countDifference} (threshold: ${duplicateThreshold})`);
            } else {
                showError(`‚ùå Test FAILED: Marker duplication detected.\n\n` +
                         `Initial markers: ${initialMarkerCount}\n` +
                         `Final markers: ${finalMarkerCount}\n` +
                         `Max markers: ${maxMarkerCount}\n` +
                         `Min markers: ${minMarkerCount}\n` +
                         `Difference: ${countDifference} (threshold: ${duplicateThreshold})`);
            }
            
            testRunning = false;
        }
        
        function showResult(message) {
            document.getElementById('testResults').style.display = 'block';
            document.getElementById('errorResults').style.display = 'none';
            document.getElementById('testResultText').textContent = message;
        }
        
        function showError(message) {
            document.getElementById('testResults').style.display = 'none';
            document.getElementById('errorResults').style.display = 'block';
            document.getElementById('errorText').textContent = message;
            testRunning = false;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Initialize the map when the page loads
        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>
</body>
</html>
